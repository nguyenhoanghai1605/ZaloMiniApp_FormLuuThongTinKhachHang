
import React, { useEffect, useState } from "react";
import { Box, Text, Input, Button, Switch, useSnackbar } from "zmp-ui"; // Import useSnackbar
import { getUserInfo } from "zmp-sdk/apis";

export default function CustomerSurveyForm() {
  const [fullName, setFullName] = useState("");
  const [phone, setPhone] = useState("");
  const [followOA, setFollowOA] = useState(false);
  const [loading, setLoading] = useState(false);
  
  // S·ª≠ d·ª•ng Snackbar c·ªßa zmp-ui ƒë·ªÉ hi·ªÉn th·ªã th√¥ng b√°o ƒë·∫πp h∆°n
  const { openSnackbar } = useSnackbar();

  // URL Web App b·∫°n v·ª´a copy ·ªü b∆∞·ªõc 2
  const APP_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwlvwK6A8De9MhM6Nz7SSYZZJC7Odyg7_30aOD8_ZKNK4S4pViCYP2f7a89O7PQFA-9/exec"; 

  useEffect(() => {
    getUserInfo({
      success: (res) => {
        if (res.userInfo?.name) {
          setFullName(res.userInfo.name);
        }
      },
      fail: (error) => {
        console.log("Kh√¥ng l·∫•y ƒë∆∞·ª£c th√¥ng tin user", error);
      }
    });
  }, []);

  const handleSubmit = async () => {
    if (!fullName || !phone) {
      openSnackbar({
        text: "Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin",
        type: "warning",
        duration: 3000,
      });
      return;
    }

    // Validate s·ªë ƒëi·ªán tho·∫°i c∆° b·∫£n
    if (phone.length < 10) {
       openSnackbar({
        text: "S·ªë ƒëi·ªán tho·∫°i kh√¥ng h·ª£p l·ªá",
        type: "warning",
        duration: 3000,
      });
      return;
    }

    setLoading(true);

    try {
      const formData = new URLSearchParams();
      formData.append("fullName", fullName);
      formData.append("phone", phone);
      formData.append("source", "Zalo Mini App");

      /**
       * L∆ØU √ù K·ª∏ THU·∫¨T:
       * Google Apps Script khi tr·∫£ v·ªÅ s·∫Ω redirect, ƒëi·ªÅu n√†y th∆∞·ªùng g√¢y l·ªói CORS tr√™n tr√¨nh duy·ªát/WebView.
       * C√°ch kh·∫Øc ph·ª•c ƒë∆°n gi·∫£n nh·∫•t l√† d√πng mode: 'no-cors'.
       * Nh∆∞·ª£c ƒëi·ªÉm: B·∫°n s·∫Ω kh√¥ng ƒë·ªçc ƒë∆∞·ª£c response "OK" t·ª´ server, nh∆∞ng data v·∫´n ƒë∆∞·ª£c ghi v√†o Sheet.
       */
      await fetch(APP_SCRIPT_URL, {
        method: "POST",
        mode: "no-cors", 
        headers: {
          "Content-Type": "application/x-www-form-urlencoded",
        },
        body: formData.toString(),
      });

      // V√¨ d√πng no-cors n√™n ta m·∫∑c ƒë·ªãnh l√† th√†nh c√¥ng n·∫øu code ch·∫°y ƒë·∫øn ƒë√¢y
      openSnackbar({
        text: "ƒêƒÉng k√Ω th√†nh c√¥ng! üéâ",
        type: "success",
        duration: 3000,
      });
      
      // Reset form sau khi g·ª≠i
      setPhone("");
      // setFullName(""); // C√≥ th·ªÉ gi·ªØ l·∫°i t√™n

    } catch (error) {
      console.error(error);
      openSnackbar({
        text: "C√≥ l·ªói x·∫£y ra, vui l√≤ng th·ª≠ l·∫°i!",
        type: "error",
        duration: 3000,
      });
    } finally {
      setLoading(false);
    }
  };

  return (
    <Box className="m-4 bg-white rounded-xl p-4 space-y-4">
      <Text.Title size="large">OQR Byoung xin ch√†o!</Text.Title>
      <Text>
        ƒêƒÉng k√Ω th√¥ng tin ƒë·ªÉ nh·∫≠n ngay <b>01 l∆∞·ª£t quay may m·∫Øn</b>
      </Text>

      <Input
        label="H·ªç t√™n c·ªßa b·∫°n *"
        value={fullName}
        onChange={(e) => setFullName(e.target.value)}
        clearable
        placeholder="Nh·∫≠p h·ªç t√™n"
      />

      <Input
        label="S·ªë ƒëi·ªán tho·∫°i c·ªßa b·∫°n *"
        value={phone}
        type="tel" // ƒê·ªïi th√†nh type tel ƒë·ªÉ b√†n ph√≠m s·ªë hi·ªán ƒë√∫ng h∆°n
        onChange={(e) => setPhone(e.target.value)}
        clearable
        placeholder="nh·∫≠p s·ªë ƒëi·ªán tho·∫°i"
      />

      <Box className="flex justify-between items-center">
        <Text>Follow OA OQR Byoung</Text>
        <Switch checked={followOA} onChange={(val) => setFollowOA(val)} />
      </Box>

      <Button
        fullWidth
        loading={loading}
        onClick={handleSubmit}
      >
        B∆∞·ªõc ti·∫øp theo
      </Button>
    </Box>
  );
}






===============
App Script: Google Sheet

function doPost(e) {
  const lock = LockService.getScriptLock();
  lock.tryLock(10000); // ƒê·ª£i t·ªëi ƒëa 10 gi√¢y ƒë·ªÉ nh·∫≠n quy·ªÅn ghi

  try {
    const SHEET_ID = "1XDrsdB1H5gK7kk139Wy2O-XxCWK83W6cyjLKnEW9xJ8";
    const SHEET_NAME = "datakh";

    const doc = SpreadsheetApp.openById(SHEET_ID);
    const sheet = doc.getSheetByName(SHEET_NAME);

    // L·∫•y d·ªØ li·ªáu t·ª´ request
    const fullName = e.parameter.fullName || "";
    const phone = e.parameter.phone || "";
    const source = e.parameter.source || "Zalo Mini App";

    // Ghi v√†o sheet
    sheet.appendRow([
      new Date(), // Th·ªùi gian ghi nh·∫≠n
      "'"+fullName, // Th√™m d·∫•u ' ƒë·ªÉ tr√°nh l·ªói format n·∫øu t√™n b·∫Øt ƒë·∫ßu b·∫±ng d·∫•u =
      "'"+phone,    // Th√™m d·∫•u ' ƒë·ªÉ gi·ªØ s·ªë 0 ·ªü ƒë·∫ßu s·ªë ƒëi·ªán tho·∫°i
      source
    ]);

    return ContentService
      .createTextOutput(JSON.stringify({ result: "success" }))
      .setMimeType(ContentService.MimeType.JSON);

  } catch (err) {
    return ContentService
      .createTextOutput(JSON.stringify({ result: "error", error: err.message }))
      .setMimeType(ContentService.MimeType.JSON);
      
  } finally {
    lock.releaseLock(); // Gi·∫£i ph√≥ng kh√≥a
  }
}





===============
H∆∞·ªõng d·∫´n
ƒê·ªÉ l·∫•y ƒë∆∞·ª£c chu·ªói AKfycb... (ƒë√≥ ch√≠nh l√† Web App URL), b·∫°n c·∫ßn th·ª±c hi·ªán thao t√°c Deploy (Tri·ªÉn khai) tr√™n trang so·∫°n th·∫£o Google Apps Script n∆°i b·∫°n ƒë√£ d√°n code doPost.

H√£y l√†m theo ƒë√∫ng 5 b∆∞·ªõc sau ƒë√¢y:

B∆∞·ªõc 1: T·∫°i giao di·ªán vi·∫øt code Apps Script, nh√¨n l√™n g√≥c tr√™n b√™n ph·∫£i, b·∫•m n√∫t m√†u xanh Deploy (Tri·ªÉn khai) -> ch·ªçn New deployment (T·∫°o quy tr√¨nh tri·ªÉn khai m·ªõi).

B∆∞·ªõc 2: M·ªôt h·ªôp tho·∫°i hi·ªán ra. B√™n c·∫°nh ch·ªØ "Select type" (Ch·ªçn lo·∫°i), b·∫•m v√†o bi·ªÉu t∆∞·ª£ng b√°nh rƒÉng ‚öôÔ∏è -> ch·ªçn Web app (·ª®ng d·ª•ng web).

B∆∞·ªõc 3: C·∫•u h√¨nh c·ª±c k·ª≥ quan tr·ªçng (L√†m sai b∆∞·ªõc n√†y Zalo App s·∫Ω kh√¥ng g·ª≠i ƒë∆∞·ª£c):

Description (M√¥ t·∫£): ƒêi·ªÅn g√¨ c≈©ng ƒë∆∞·ª£c (v√≠ d·ª•: K·∫øt n·ªëi Zalo).

Execute as (Th·ª±c thi d∆∞·ªõi d·∫°ng): Ch·ªçn Me (T√¥i) (nghƒ©a l√† script ch·∫°y b·∫±ng quy·ªÅn c·ªßa b·∫°n ƒë·ªÉ ghi v√†o Sheet).

Who has access (Ai c√≥ quy·ªÅn truy c·∫≠p): Ch·ªçn Anyone (B·∫•t k·ª≥ ai).

L∆∞u √Ω: B·∫Øt bu·ªôc ph·∫£i ch·ªçn "Anyone" th√¨ Zalo Mini App (l√† ng∆∞·ªùi ngo√†i) m·ªõi g·ªçi ƒë∆∞·ª£c v√†o code n√†y.

B∆∞·ªõc 4: B·∫•m n√∫t Deploy (Tri·ªÉn khai) ·ªü d∆∞·ªõi c√πng. (N·∫øu l√† l·∫ßn ƒë·∫ßu, Google s·∫Ω y√™u c·∫ßu b·∫°n c·∫•p quy·ªÅn. H√£y b·∫•m "Review permissions" -> Ch·ªçn mail b·∫°n -> B·∫•m "Advanced" (N√¢ng cao) -> B·∫•m "Go to... (unsafe)" -> B·∫•m "Allow".)

B∆∞·ªõc 5: Sau khi xong, n√≥ s·∫Ω hi·ªán ra m·ªôt c√°i link d√†i ·ªü √¥ Web app URL.

Link n√†y s·∫Ω c√≥ d·∫°ng: https://script.google.com/macros/s/AKfycb.../exec

B·∫°n b·∫•m n√∫t Copy ƒë·ªÉ sao ch√©p link n√†y.

üëâ Cu·ªëi c√πng: D√°n to√†n b·ªô ƒë∆∞·ªùng link v·ª´a copy v√†o bi·∫øn APP_SCRIPT_URL trong file code React (index.tsx) c·ªßa b·∫°n.